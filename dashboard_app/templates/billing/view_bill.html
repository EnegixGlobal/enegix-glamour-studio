{% extends "base2.html" %}
{% load static %}
{% block content %}

<div class="ribbon-header d-flex justify-content-between align-items-center px-4 pb-5 mb-3 no-print" style="color: black">
  <div class="d-flex align-items-center">
    <i class="fas fa-file-invoice me-3 fs-2" style="color: #ff4f6e;"></i>
    <div class="fw-bold fs-3">Bill - {{ bill.bill_id }}</div>
  </div>
  <div class="breadcrumb-text text-end">
    <span class="text-black"><i class="fas fa-home me-1"></i>HOME</span>
    <span class="mx-2 text-black">/</span>
    <a href="{% url 'bill_list' %}" class="text-black">Bills</a>
    <span class="mx-2 text-black">/</span>
    <span class="text-black-50">View</span>
  </div>
</div>

<div class="container-fluid mt-2">
  <!-- Print Button (Top) -->
  <div class="text-end mb-3 no-print">
    <button onclick="window.location.href='{% url 'print_bill' bill.id %}'" class="btn btn-primary btn-action-lg">
      <i class="fas fa-print me-2"></i>Print Bill
    </button>
  </div>

  <!-- Bill Document -->
  <div class="bill-container">
    <!-- Header -->
    <div class="bill-header">
      <div class="row">
        <div class="col-md-6">
          <h2 class="salon-name">Salon Management System</h2>
          <p class="salon-address">
            <i class="fas fa-map-marker-alt me-2"></i>Your Salon Address Here<br>
            <i class="fas fa-phone me-2"></i>Contact: +91 XXXXXXXXXX<br>
            <i class="fas fa-envelope me-2"></i>Email: info@salon.com
          </p>
        </div>
        <div class="col-md-6 text-end">
          <div class="bill-title">TAX INVOICE</div>
          <div class="bill-id">{{ bill.bill_id }}</div>
          <p class="bill-date">
            <strong>Date:</strong> {{ bill.bill_date|date:"d M, Y - h:i A" }}
          </p>
        </div>
      </div>
    </div>

    <hr class="bill-divider">

    <!-- Customer & Appointment Info -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="info-section">
          <h6 class="section-header">Bill To:</h6>
          <p class="mb-1"><strong>{{ bill.customer.full_name }}</strong></p>
          <p class="mb-1">Customer ID: {{ bill.customer.customer_id }}</p>
          <p class="mb-1"><i class="fas fa-mobile-alt me-2"></i>{{ bill.customer.mobile }}</p>
          {% if bill.customer.email %}
          <p class="mb-0"><i class="fas fa-envelope me-2"></i>{{ bill.customer.email }}</p>
          {% endif %}
        </div>
      </div>
      <div class="col-md-6">
        <div class="info-section">
          <h6 class="section-header">Appointment Details:</h6>
          <p class="mb-1"><strong>Appointment ID:</strong> {{ bill.appointment.appointment_id }}</p>
          <p class="mb-1"><strong>Date:</strong> {{ bill.appointment.appointment_date|date:"d M, Y" }}</p>
          <p class="mb-1"><strong>Time:</strong> {{ bill.appointment.appointment_time }}</p>
          <p class="mb-0">
            <strong>Status:</strong>
            {% if bill.payment_status == 'paid' %}
              <span class="badge-paid">Paid</span>
            {% elif bill.payment_status == 'partial' %}
              <span class="badge-partial">Partial</span>
            {% else %}
              <span class="badge-pending">Pending</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>

    <!-- Services Table -->
    <div class="table-responsive mb-4">
      <table class="bill-table">
        <thead>
          <tr>
            <th>S.No</th>
            <th>Service Description</th>
            <th>Stylist/Employee</th>
            <th class="text-center">Qty</th>
            <th class="text-end">Rate</th>
            <th class="text-end">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for item in bill_items %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td><strong>{{ item.service_name }}</strong></td>
            <td>{{ item.employee_name }}</td>
            <td class="text-center">{{ item.quantity }}</td>
            <td class="text-end">₹{{ item.price|floatformat:2 }}</td>
            <td class="text-end">₹{{ item.subtotal|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Bill Summary -->
    <div class="row">
      <div class="col-md-6">
        <div class="payment-info">
          <h6 class="section-header">Payment Information:</h6>
          <p class="mb-1">
            <strong>Payment Method:</strong>
            {% if bill.payment_method == 'cash' %}
              <i class="fas fa-money-bill me-1"></i>Cash
            {% elif bill.payment_method == 'card' %}
              <i class="fas fa-credit-card me-1"></i>Card
            {% elif bill.payment_method == 'upi' %}
              <i class="fas fa-mobile-alt me-1"></i>UPI
            {% elif bill.payment_method == 'online' %}
              <i class="fas fa-globe me-1"></i>Online
            {% endif %}
          </p>
          {% if bill.notes %}
          <p class="mb-0"><strong>Notes:</strong> {{ bill.notes }}</p>
          {% endif %}
        </div>
      </div>

      <div class="col-md-6">
        <div class="bill-totals">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>₹{{ bill.subtotal|floatformat:2 }}</span>
          </div>
          {% if bill.discount > 0 %}
          <div class="total-row discount-row">
            <span>Discount:</span>
            <span>- ₹{{ bill.discount|floatformat:2 }}</span>
          </div>
          {% endif %}
          {% if bill.gst_amount > 0 %}
          <div class="total-row">
            <span>GST:</span>
            <span>+ ₹{{ bill.gst_amount|floatformat:2 }}</span>
          </div>
          {% endif %}
          <hr class="total-divider">
          <div class="total-row grand-total">
            <span><strong>Grand Total:</strong></span>
            <span><strong>₹{{ bill.total_amount|floatformat:2 }}</strong></span>
          </div>
          {% if bill.appointment.advance_paid > 0 %}
          <div class="total-row" style="color: #28a745;">
            <span><i class="fas fa-hand-holding-usd me-2"></i>Advance (collected at booking):</span>
            <span>- ₹{{ bill.appointment.advance_paid|floatformat:2 }}</span>
          </div>
          {% endif %}
          <div class="total-row paid-row">
            <span>Total Amount Paid:</span>
            <span>₹{{ bill.amount_paid|floatformat:2 }}</span>
          </div>
          <hr class="total-divider">
          <div class="total-row balance-row">
            <span><strong>Balance Due:</strong></span>
            <span><strong>₹{{ bill.balance_amount|floatformat:2 }}</strong></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="bill-footer">
      <hr class="bill-divider">
      <div class="row">
        <div class="col-md-6">
          <p class="mb-0"><strong>Generated by:</strong>
            {% if bill.generated_by %}
              {{ bill.generated_by.full_name }} ({{ bill.generated_by.employee_id }})
            {% else %}
              Super Admin
            {% endif %}
          </p>
        </div>
        <div class="col-md-6 text-end">
          <p class="mb-0"><strong>Thank you for your visit!</strong></p>
          <p class="text-muted small mb-0">Looking forward to serving you again</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons (No Print) -->
  <div class="card shadow-lg mb-4 modern-card no-print mt-4">
    <div class="card-body p-4">
      <div class="d-flex justify-content-between flex-wrap gap-3">
        <a href="{% url 'bill_list' %}" class="btn btn-secondary btn-action-lg">
          <i class="fas fa-arrow-left me-2"></i>Back to Bills
        </a>

        <div class="d-flex gap-3 flex-wrap">
          <a href="{% url 'view_appointment' bill.appointment.id %}" class="btn btn-info btn-action-lg">
            <i class="fas fa-calendar-alt me-2"></i>View Appointment
          </a>

          <a href="{% url 'view_customer' bill.customer.id %}" class="btn btn-primary btn-action-lg">
            <i class="fas fa-user me-2"></i>View Customer
          </a>

          {% if bill.payment_status != 'paid' %}
          <a href="{% url 'update_payment' bill.id %}" class="btn btn-warning btn-action-lg">
            <i class="fas fa-rupee-sign me-2"></i>Update Payment
          </a>
          {% endif %}

          <!-- ✅ UPDATED: Print button redirects to professional print page -->
          <button onclick="window.location.href='{% url 'print_bill' bill.id %}'" class="btn btn-success btn-action-lg">
            <i class="fas fa-print me-2"></i>Print Bill
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.bill-container { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto; }
.bill-header { margin-bottom: 20px; }
.salon-name { color: #ff4f6e; font-weight: 700; font-size: 28px; margin-bottom: 10px; }
.salon-address { color: #666; font-size: 14px; line-height: 1.8; }
.bill-title { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 10px; }
.bill-id { background: linear-gradient(135deg, #28a745 0%, #48c774 100%); color: white; padding: 8px 20px; border-radius: 25px; font-weight: 600; font-size: 16px; display: inline-block; margin-bottom: 10px; }
.bill-date { color: #666; font-size: 14px; }
.bill-divider { border: none; border-top: 2px solid #ff4f6e; margin: 20px 0; }
.info-section { background: #fff5f7; padding: 20px; border-radius: 10px; border: 2px solid #ffe9ed; }
.section-header { color: #ff4f6e; font-weight: 700; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #ffe9ed; padding-bottom: 10px; }
.badge-paid { background: linear-gradient(135deg, #28a745 0%, #48c774 100%); color: white; padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: 600; }
.badge-partial { background: linear-gradient(135deg, #ffc107 0%, #ffd454 100%); color: #333; padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: 600; }
.badge-pending { background: linear-gradient(135deg, #dc3545 0%, #e4606d 100%); color: white; padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: 600; }
.bill-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
.bill-table thead { background: linear-gradient(135deg, #ff4f6e 0%, #ff80ab 100%); color: white; }
.bill-table th { padding: 15px; text-align: left; font-weight: 600; font-size: 14px; }
.bill-table tbody tr { border-bottom: 1px solid #e0e0e0; }
.bill-table tbody tr:hover { background: #fff5f7; }
.bill-table td { padding: 15px; font-size: 14px; color: #333; }
.bill-totals { background: #fff5f7; padding: 20px; border-radius: 10px; border: 2px solid #ffe9ed; }
.total-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 15px; color: #333; }
.discount-row { color: #dc3545; }
.total-divider { border: none; border-top: 1px solid #e0e0e0; margin: 10px 0; }
.grand-total { font-size: 18px; color: #28a745; background: #e7f9f0; padding: 15px; border-radius: 8px; margin: 10px 0; }
.paid-row { color: #17a2b8; }
.balance-row { font-size: 18px; color: #dc3545; background: #ffe9ed; padding: 15px; border-radius: 8px; margin: 10px 0; }
.payment-info { background: #fff5f7; padding: 20px; border-radius: 10px; border: 2px solid #ffe9ed; }
.bill-footer { margin-top: 40px; color: #666; font-size: 14px; }
.modern-card { border-radius: 15px; border: none; overflow: hidden; }
.btn-action-lg { padding: 12px 30px; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; }
.btn-action-lg:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.btn-primary { background: linear-gradient(135deg, #ff4f6e 0%, #ff80ab 100%); border: none; }
.btn-primary:hover { background: linear-gradient(135deg, #e63956 0%, #ff6b9d 100%); }
.btn-success { background: linear-gradient(135deg, #28a745 0%, #48c774 100%); border: none; }
.btn-success:hover { background: linear-gradient(135deg, #218838 0%, #28a745 100%); }
.btn-info { background: linear-gradient(135deg, #17a2b8 0%, #3dbdd1 100%); border: none; }
.btn-info:hover { background: linear-gradient(135deg, #138496 0%, #17a2b8 100%); }
.btn-warning { background: linear-gradient(135deg, #ffc107 0%, #ffd454 100%); border: none; color: #333; }
.btn-warning:hover { background: linear-gradient(135deg, #e0a800 0%, #ffc107 100%); }
.ribbon-header { background: linear-gradient(135deg, #fff5f7 0%, #ffe9ed 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(255, 79, 110, 0.05); }

@media print {
  .no-print { display: none !important; }
  body { background: white; }
  .bill-container { box-shadow: none; padding: 20px; }
  .btn-action-lg { display: none; }
  @page { margin: 1cm; }
}
</style>

{% endblock %}